<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Management System - Real-Time Sync</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: #f5f7fa; color: #333; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, var(--primary), var(--dark)); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; }
        .sync-status { display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; background-color: var(--success); animation: pulse 2s infinite; }
        .status-indicator.offline { background-color: var(--danger); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .login-container { background-color: white; border-radius: 10px; padding: 30px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); max-width: 400px; margin: 50px auto; }
        .login-container h2 { text-align: center; margin-bottom: 20px; color: var(--primary); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--dark); }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; transition: border 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: var(--secondary); outline: none; }
        button { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600; transition: all 0.3s ease; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        .btn-secondary { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }
        .btn-success { background: linear-gradient(135deg, var(--success), #27ae60); }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #e67e22); }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #c0392b); }
        .dashboard { display: none; background-color: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 20px; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .user-info { font-weight: 600; color: var(--primary); }
        .tabs { display: flex; margin-bottom: 20px; border-bottom: 1px solid #ddd; flex-wrap: wrap; }
        .tab { padding: 12px 20px; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; }
        .tab:hover { background-color: #f8f9fa; }
        .tab.active { border-bottom: 3px solid var(--secondary); font-weight: 600; color: var(--secondary); }
        .tab-content { display: none; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; font-weight: 600; color: var(--dark); }
        tr:hover { background-color: #f8f9fa; }
        .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-approved { background-color: #d4edda; color: #155724; }
        .status-rejected { background-color: #f8d7da; color: #721c24; }
        .status-inactive { background-color: #e2e3e5; color: #383d41; }
        .action-buttons { display: flex; gap: 5px; }
        .action-btn { padding: 6px 12px; font-size: 14px; border: none; border-radius: 4px; cursor: pointer; transition: all 0.3s; }
        .form-container { background-color: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .card { background-color: white; border-radius: 5px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        .card h3 { margin-bottom: 10px; color: var(--primary); }
        .guidelines { line-height: 1.6; }
        .guidelines ul { margin-left: 20px; margin-bottom: 15px; }
        .time-display { font-size: 18px; font-weight: bold; text-align: center; margin: 10px 0; color: var(--secondary); background-color: #f8f9fa; padding: 10px; border-radius: 5px; }
        .attendance-form { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .attendance-form input, .attendance-form select { flex: 1; min-width: 150px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .message { padding: 10px; border-radius: 5px; margin-bottom: 15px; text-align: center; display: none; }
        .message.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .recent-activity { background-color: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-top: 20px; }
        .activity-item { padding: 10px; border-left: 3px solid var(--secondary); margin-bottom: 10px; background-color: #f8f9fa; }
        @media (max-width: 768px) {
            .grid-2 { grid-template-columns: 1fr; }
            .attendance-form { flex-direction: column; }
            .tabs { overflow-x: auto; }
            .action-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>School Management System</h1>
            <div class="sync-status">
                <div class="status-indicator" id="sync-status"></div>
                <span id="sync-text">Syncing...</span>
            </div>
        </header>

        <!-- Login Section -->
        <div id="login-section" class="login-container">
            <h2>Login to Your Account</h2>
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" placeholder="Enter your username">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" placeholder="Enter your password">
            </div>
            <div class="form-group">
                <label for="role">Role</label>
                <select id="role">
                    <option value="admin">Administrator</option>
                    <option value="teacher">Teacher</option>
                    <option value="student">Student</option>
                </select>
            </div>
            <button id="login-btn">Login</button>
            
            <div id="login-message" class="message"></div>
            
            <div style="margin-top: 20px; text-align: center;">
                <p><strong>Demo Credentials:</strong></p>
                <p>Admin: admin / admin123</p>
                <p>Teacher: teacher1 / pass123</p>
                <p>Student: student1 / stud123</p>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="dashboard">
            <div class="dashboard-header">
                <h2>Administrator Dashboard</h2>
                <div>
                    <span class="user-info">Welcome, Admin</span>
                    <button class="btn-danger" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('admin', 'attendance')">Teacher Attendance</div>
                <div class="tab" onclick="switchTab('admin', 'lesson-notes')">Lesson Notes</div>
                <div class="tab" onclick="switchTab('admin', 'assignments')">Assignments</div>
                <div class="tab" onclick="switchTab('admin', 'students')">Student Management</div>
                <div class="tab" onclick="switchTab('admin', 'teachers')">Teacher Management</div>
            </div>

            <!-- Teacher Attendance Tab -->
            <div id="admin-attendance" class="tab-content active">
                <h3>Teacher Attendance Records</h3>
                
                <div class="form-container">
                    <h4>Record Teacher Attendance</h4>
                    <div class="time-display">Current Time: <span id="time-display"></span></div>
                    <div class="attendance-form">
                        <select id="teacher-select">
                            <option value="">Select Teacher</option>
                        </select>
                        <select id="attendance-type">
                            <option value="arrival">Record Arrival</option>
                            <option value="departure">Record Departure</option>
                        </select>
                        <button onclick="recordAttendance()">Record Attendance</button>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Teacher</th>
                            <th>Arrival Time</th>
                            <th>Departure Time</th>
                            <th>Hours Worked</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-table"></tbody>
                </table>
            </div>

            <!-- Lesson Notes Tab -->
            <div id="admin-lesson-notes" class="tab-content">
                <h3>Lesson Notes Management</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Teacher</th>
                            <th>Date</th>
                            <th>Subject</th>
                            <th>Lesson Note</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="lesson-notes-table"></tbody>
                </table>
            </div>

            <!-- Assignments Tab -->
            <div id="admin-assignments" class="tab-content">
                <h3>Assignments Management</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Teacher</th>
                            <th>Class</th>
                            <th>Subject</th>
                            <th>Assignment</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="assignments-table"></tbody>
                </table>
            </div>

            <!-- Student Management Tab -->
            <div id="admin-students" class="tab-content">
                <h3>Student Management</h3>
                
                <div class="form-container">
                    <h4>Add New Student</h4>
                    <div class="grid-2">
                        <input type="text" id="student-name" placeholder="Student Name">
                        <select id="student-class">
                            <option value="">Select Class</option>
                            <option value="Grade 1">Grade 1</option>
                            <option value="Grade 2">Grade 2</option>
                            <option value="Grade 3">Grade 3</option>
                        </select>
                    </div>
                    <button onclick="addStudent()" style="margin-top: 15px;">Add Student</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Name</th>
                            <th>Class</th>
                            <th>Username</th>
                            <th>Password</th>
                            <th>Added By</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="students-table"></tbody>
                </table>
            </div>

            <!-- Teacher Management Tab -->
            <div id="admin-teachers" class="tab-content">
                <h3>Teacher Management</h3>
                
                <div class="form-container">
                    <h4>Register New Teacher</h4>
                    <div class="grid-2">
                        <input type="text" id="teacher-name" placeholder="Teacher Full Name">
                        <input type="email" id="teacher-email" placeholder="Teacher Email">
                        <select id="teacher-class">
                            <option value="">Assign to Class</option>
                            <option value="Grade 1">Grade 1</option>
                            <option value="Grade 2">Grade 2</option>
                            <option value="Grade 3">Grade 3</option>
                        </select>
                        <input type="text" id="teacher-subject" placeholder="Primary Subject">
                    </div>
                    <button onclick="registerTeacher()" style="margin-top: 15px;">Register Teacher</button>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Teacher ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Class</th>
                            <th>Subject</th>
                            <th>Username</th>
                            <th>Password</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="teachers-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Teacher Dashboard -->
        <div id="teacher-dashboard" class="dashboard">
            <div class="dashboard-header">
                <h2>Teacher Dashboard</h2>
                <div>
                    <span class="user-info" id="teacher-welcome">Welcome, Teacher</span>
                    <button class="btn-danger" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('teacher', 'attendance')">My Attendance</div>
                <div class="tab" onclick="switchTab('teacher', 'guidelines')">Guidelines</div>
                <div class="tab" onclick="switchTab('teacher', 'submit-lesson')">Submit Lesson Note</div>
                <div class="tab" onclick="switchTab('teacher', 'my-lessons')">My Lesson Notes</div>
                <div class="tab" onclick="switchTab('teacher', 'submit-assignment')">Submit Assignment</div>
                <div class="tab" onclick="switchTab('teacher', 'my-assignments')">My Assignments</div>
            </div>

            <!-- Teacher Attendance Tab -->
            <div id="teacher-attendance" class="tab-content active">
                <h3>My Attendance Records</h3>
                <div class="time-display">Current Time: <span id="teacher-time-display"></span></div>
                
                <div class="form-container">
                    <h4>Record My Attendance</h4>
                    <div class="attendance-form">
                        <select id="teacher-attendance-type">
                            <option value="arrival">Record My Arrival</option>
                            <option value="departure">Record My Departure</option>
                        </select>
                        <button onclick="recordMyAttendance()">Record Attendance</button>
                    </div>
                </div>
                
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Arrival Time</th>
                            <th>Departure Time</th>
                            <th>Hours Worked</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="teacher-attendance-table"></tbody>
                </table>
            </div>

            <!-- Guidelines Tab -->
            <div id="teacher-guidelines" class="tab-content">
                <h3>Teacher Guidelines</h3>
                <div class="guidelines">
                    <div class="card">
                        <h3>Lesson Note Writing Guidelines</h3>
                        <ul>
                            <li>Include clear learning objectives for each lesson</li>
                            <li>Detail the teaching methodology to be used</li>
                            <li>List required materials and resources</li>
                            <li>Outline the lesson structure and timing</li>
                            <li>Include assessment methods and evaluation criteria</li>
                            <li>Specify homework or follow-up activities</li>
                        </ul>
                    </div>
                    
                    <div class="card">
                        <h3>Assignment Creation Guidelines</h3>
                        <ul>
                            <li>Clearly state the assignment objectives</li>
                            <li>Provide detailed instructions for completion</li>
                            <li>Specify the submission deadline</li>
                            <li>Include grading criteria and rubrics</li>
                            <li>Ensure assignments align with curriculum standards</li>
                            <li>Consider diverse learning needs when designing tasks</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Submit Lesson Note Tab -->
            <div id="teacher-submit-lesson" class="tab-content">
                <h3>Submit New Lesson Note</h3>
                <div class="form-container">
                    <div class="form-group">
                        <label for="lesson-subject">Subject</label>
                        <input type="text" id="lesson-subject" placeholder="Enter subject">
                    </div>
                    <div class="form-group">
                        <label for="lesson-note">Lesson Note</label>
                        <textarea id="lesson-note" rows="6" placeholder="Enter your lesson note details"></textarea>
                    </div>
                    <button onclick="submitLessonNote()">Submit Lesson Note</button>
                </div>
            </div>

            <!-- My Lesson Notes Tab -->
            <div id="teacher-my-lessons" class="tab-content">
                <h3>My Submitted Lesson Notes</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Subject</th>
                            <th>Lesson Note</th>
                            <th>Status</th>
                            <th>Feedback</th>
                        </tr>
                    </thead>
                    <tbody id="teacher-lessons-table"></tbody>
                </table>
            </div>

            <!-- Submit Assignment Tab -->
            <div id="teacher-submit-assignment" class="tab-content">
                <h3>Create New Assignment</h3>
                <div class="form-container">
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="assignment-class">Class</label>
                            <select id="assignment-class">
                                <option value="">Select Class</option>
                                <option value="Grade 1">Grade 1</option>
                                <option value="Grade 2">Grade 2</option>
                                <option value="Grade 3">Grade 3</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="assignment-subject">Subject</label>
                            <input type="text" id="assignment-subject" placeholder="Enter subject">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="assignment-details">Assignment Details</label>
                        <textarea id="assignment-details" rows="4" placeholder="Enter assignment details"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="due-date">Due Date</label>
                        <input type="date" id="due-date">
                    </div>
                    <button onclick="submitAssignment()">Submit Assignment</button>
                </div>
            </div>

            <!-- My Assignments Tab -->
            <div id="teacher-my-assignments" class="tab-content">
                <h3>My Submitted Assignments</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Class</th>
                            <th>Subject</th>
                            <th>Assignment</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Feedback</th>
                        </tr>
                    </thead>
                    <tbody id="teacher-assignments-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Student Dashboard -->
        <div id="student-dashboard" class="dashboard">
            <div class="dashboard-header">
                <h2>Student Dashboard</h2>
                <div>
                    <span class="user-info">Welcome, Student</span>
                    <button class="btn-danger" onclick="logout()">Logout</button>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('student', 'my-assignments')">My Assignments</div>
            </div>

            <!-- My Assignments Tab -->
            <div id="student-my-assignments" class="tab-content active">
                <h3>My Assignments</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Teacher</th>
                            <th>Subject</th>
                            <th>Assignment</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Feedback</th>
                        </tr>
                    </thead>
                    <tbody id="student-assignments-table"></tbody>
                </table>
            </div>
        </div>

        <!-- Recent Activity Section -->
        <div class="recent-activity">
            <h3>Recent System Activity</h3>
            <div id="activity-feed"></div>
        </div>
    </div>

    <!-- Firebase (compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script>
      // Use your existing Firebase project (from earlier message)
      const firebaseConfig = {
        apiKey: "AIzaSyAjN-cIyk3P3BngHq_4rhJ_fCot-QpdVi8",
        authDomain: "attendance-9cfab.firebaseapp.com",
        projectId: "attendance-9cfab",
        storageBucket: "attendance-9cfab.firebasestorage.app",
        messagingSenderId: "930402251687",
        appId: "1:930402251687:web:3b66bcc47361c297d53c82",
        measurementId: "G-HB6ELX39DD"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
    </script>

    <script>
        // Real-time synchronization using WebSockets (simulated)
        class RealTimeSync {
            constructor() {
                this.connected = false;
                this.syncInterval = null;
                this.lastSync = null;
                this.init();
            }
            init() {
                this.simulateConnection();
                this.syncInterval = setInterval(() => { this.syncData(); }, 5000);
                window.addEventListener('online', () => { this.setConnectionStatus(true); this.syncData(); });
                window.addEventListener('offline', () => { this.setConnectionStatus(false); });
            }
            simulateConnection() {
                setTimeout(() => { this.setConnectionStatus(true); this.syncData(); }, 1000);
            }
            setConnectionStatus(connected) {
                this.connected = connected;
                const statusIndicator = document.getElementById('sync-status');
                const statusText = document.getElementById('sync-text');
                if (connected) {
                    statusIndicator.classList.remove('offline');
                    statusText.textContent = 'Synced';
                    this.addActivity('System connected and synced');
                } else {
                    statusIndicator.classList.add('offline');
                    statusText.textContent = 'Offline - Changes saved locally';
                    this.addActivity('Connection lost - working offline');
                }
            }
            syncData() {
                if (!this.connected) return;
                this.lastSync = new Date();
                const statusText = document.getElementById('sync-text');
                statusText.textContent = 'Syncing...';
                setTimeout(() => {
                    if (this.connected) statusText.textContent = `Synced ${this.formatTime(this.lastSync)}`;
                }, 1000);
                this.addActivity('Data synchronized across devices');
            }
            // CHANGED: also mirror to Firestore so another device can fetch it
            saveData(key, data) {
                localStorage.setItem(`schoolSystem_${key}`, JSON.stringify(data));
                // Mirror to Firestore (single doc per key)
                try {
                    db.collection('schoolSystem').doc(key).set({ items: data, updatedAt: Date.now() });
                } catch(e) { /* ignore */ }
                if (this.connected) this.syncData();
                this.addActivity(`Updated ${key}`);
            }
            getLocalData() {
                const data = {};
                const keys = Object.keys(localStorage).filter(key => key.startsWith('schoolSystem_'));
                keys.forEach(key => {
                    const cleanKey = key.replace('schoolSystem_', '');
                    data[cleanKey] = JSON.parse(localStorage.getItem(key));
                });
                return data;
            }
            addActivity(message) {
                const activityFeed = document.getElementById('activity-feed');
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                activityItem.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
                activityFeed.insertBefore(activityItem, activityFeed.firstChild);
                if (activityFeed.children.length > 10) activityFeed.removeChild(activityFeed.lastChild);
            }
            formatTime(date) { return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
        }
        const realTimeSync = new RealTimeSync();

        const dataStructure = { users: [], attendance: [], lessonNotes: [], assignments: [], students: [] };

        // CHANGED: make initializeData async and pull from Firestore if local is empty
        async function initializeData() {
            for (const key of Object.keys(dataStructure)) {
                const stored = localStorage.getItem(`schoolSystem_${key}`);
                if (!stored) {
                    // try cloud first
                    try {
                        const doc = await db.collection('schoolSystem').doc(key).get();
                        if (doc.exists && Array.isArray(doc.data().items)) {
                            localStorage.setItem(`schoolSystem_${key}`, JSON.stringify(doc.data().items));
                            continue; // got cloud copy; don't overwrite
                        }
                    } catch(e) { /* ignore */ }

                    // seed defaults if nothing in cloud
                    if (key === 'users') {
                        const defaultUsers = [
                            { username: 'admin', password: 'admin123', role: 'admin', name: 'Administrator', status: 'active' },
                            { username: 'teacher1', password: 'pass123', role: 'teacher', name: 'John Smith', class: 'Grade 1', email: 'john.smith@school.edu', subject: 'Mathematics', status: 'active' },
                            { username: 'teacher2', password: 'pass123', role: 'teacher', name: 'Sarah Johnson', class: 'Grade 2', email: 'sarah.johnson@school.edu', subject: 'Science', status: 'active' },
                            { username: 'student1', password: 'stud123', role: 'student', name: 'Michael Brown', class: 'Grade 1', status: 'active' },
                            { username: 'student2', password: 'stud123', role: 'student', name: 'Emily Davis', class: 'Grade 2', status: 'active' }
                        ];
                        realTimeSync.saveData(key, defaultUsers);
                    } else if (key === 'attendance') {
                        const defaultAttendance = [
                            { date: '2023-10-01', teacher: 'John Smith', arrival: '08:00', departure: '15:30', hours: 7.5, status: 'complete' },
                            { date: '2023-10-01', teacher: 'Sarah Johnson', arrival: '08:15', departure: '15:45', hours: 7.5, status: 'complete' },
                            { date: '2023-10-02', teacher: 'John Smith', arrival: '07:55', departure: '15:25', hours: 7.5, status: 'complete' }
                        ];
                        realTimeSync.saveData(key, defaultAttendance);
                    } else {
                        realTimeSync.saveData(key, []);
                    }
                }
            }
        }

        let currentUser = null;
        let timeInterval;

        // CHANGED: make the loader async so we can await initializeData()
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeData(); // ensure fresh device pulls cloud copy before login
            const savedUser = sessionStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showDashboard();
            }
            updateClock();
            timeInterval = setInterval(updateClock, 1000);
            populateTeacherSelect();
            document.getElementById('login-btn').addEventListener('click', login);
            document.getElementById('password').addEventListener('keypress', function(e) { if (e.key === 'Enter') login(); });
            realTimeSync.addActivity('School management system loaded');
        });

        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('time-display').textContent = timeString;
            document.getElementById('teacher-time-display').textContent = timeString;
        }

        // Login function (unchanged logic; now benefits from cloud-backed initializeData)
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;
            const messageEl = document.getElementById('login-message');

            if (!username || !password) {
                showMessage(messageEl, 'Please enter both username and password', 'error');
                return;
            }
            const users = JSON.parse(localStorage.getItem('schoolSystem_users') || '[]');
            const user = users.find(u => u.username === username && u.password === password && u.role === role && u.status === 'active');
            if (user) {
                currentUser = user;
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                showDashboard();
                realTimeSync.addActivity(`${user.name} logged in as ${user.role}`);
            } else {
                showMessage(messageEl, 'Invalid username, password, or role selection', 'error');
            }
        }

        function showDashboard() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'none';
            document.getElementById('teacher-dashboard').style.display = 'none';
            document.getElementById('student-dashboard').style.display = 'none';
            if (currentUser.role === 'admin') {
                document.getElementById('admin-dashboard').style.display = 'block';
                updateAdminDashboard();
            } else if (currentUser.role === 'teacher') {
                document.getElementById('teacher-dashboard').style.display = 'block';
                document.getElementById('teacher-welcome').textContent = `Welcome, ${currentUser.name}`;
                updateTeacherDashboard();
            } else if (currentUser.role === 'student') {
                document.getElementById('student-dashboard').style.display = 'block';
                updateStudentDashboard();
            }
        }

        function logout() {
            realTimeSync.addActivity(`${currentUser.name} logged out`);
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            document.getElementById('admin-dashboard').style.display = 'none';
            document.getElementById('teacher-dashboard').style.display = 'none';
            document.getElementById('student-dashboard').style.display = 'none';
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('role').value = 'admin';
        }

        function switchTab(userType, tabName) {
            const tabContents = document.querySelectorAll(`#${userType}-dashboard .tab-content`);
            tabContents.forEach(tab => tab.classList.remove('active'));
            const tabs = document.querySelectorAll(`#${userType}-dashboard .tab`);
            tabs.forEach(tab => tab.classList.remove('active'));
            document.getElementById(`${userType}-${tabName}`).classList.add('active');
            for (let tab of tabs) {
                if (tab.textContent.trim().toLowerCase().replace(/\s+/g, '-') === tabName) {
                    tab.classList.add('active');
                    break;
                }
            }
        }

        function getData(key) {
            return JSON.parse(localStorage.getItem(`schoolSystem_${key}`) || '[]');
        }

        // CHANGED: saveData already mirrors to Firestore via realTimeSync.saveData()
        function saveData(key, data) {
            realTimeSync.saveData(key, data);
        }

        function updateAdminDashboard() {
            const attendance = getData('attendance');
            const lessonNotes = getData('lessonNotes');
            const assignments = getData('assignments');
            const students = getData('students');
            const users = getData('users');
            const teachers = users.filter(user => user.role === 'teacher');

            const attendanceTable = document.getElementById('attendance-table');
            attendanceTable.innerHTML = '';
            const sortedAttendance = [...attendance].sort((a, b) => new Date(b.date) - new Date(a.date));
            sortedAttendance.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.teacher}</td>
                    <td>${record.arrival || '-'}</td>
                    <td>${record.departure || '-'}</td>
                    <td>${record.hours > 0 ? record.hours + ' hours' : '-'}</td>
                    <td><span class="status status-${record.status === 'complete' ? 'approved' : 'pending'}">${record.status}</span></td>
                `;
                attendanceTable.appendChild(row);
            });

            const lessonNotesTable = document.getElementById('lesson-notes-table');
            lessonNotesTable.innerHTML = '';
            lessonNotes.forEach(note => {
                const statusClass = `status-${note.status}`;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${note.teacher}</td>
                    <td>${note.date}</td>
                    <td>${note.subject}</td>
                    <td>${note.note}</td>
                    <td><span class="status ${statusClass}">${note.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            ${note.status === 'pending' ? 
                                `<button class="action-btn btn-success" onclick="approveLessonNote(${note.id})">Approve</button>
                                 <button class="action-btn btn-danger" onclick="rejectLessonNote(${note.id})">Reject</button>` : 
                                '<span>Action taken</span>'
                            }
                        </div>
                    </td>
                `;
                lessonNotesTable.appendChild(row);
            });

            const assignmentsTable = document.getElementById('assignments-table');
            assignmentsTable.innerHTML = '';
            assignments.forEach(assignment => {
                const statusClass = `status-${assignment.status}`;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${assignment.teacher}</td>
                    <td>${assignment.class}</td>
                    <td>${assignment.subject}</td>
                    <td>${assignment.assignment}</td>
                    <td>${assignment.dueDate}</td>
                    <td><span class="status ${statusClass}">${assignment.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            ${assignment.status === 'pending' ? 
                                `<button class="action-btn btn-success" onclick="approveAssignment(${assignment.id})">Approve</button>
                                 <button class="action-btn btn-danger" onclick="rejectAssignment(${assignment.id})">Reject</button>` : 
                                '<span>Action taken</span>'
                            }
                        </div>
                    </td>
                `;
                assignmentsTable.appendChild(row);
            });

            const studentsTable = document.getElementById('students-table');
            studentsTable.innerHTML = '';
            students.forEach(student => {
                const statusClass = `status-${student.status}`;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.name}</td>
                    <td>${student.class}</td>
                    <td>${student.username}</td>
                    <td>${student.password}</td>
                    <td>${student.addedBy}</td>
                    <td><span class="status ${statusClass}">${student.status}</span></td>
                `;
                studentsTable.appendChild(row);
            });

            const teachersTable = document.getElementById('teachers-table');
            teachersTable.innerHTML = '';
            teachers.forEach(teacher => {
                const statusClass = `status-${teacher.status}`;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>TCH${teachers.indexOf(teacher) + 1}</td>
                    <td>${teacher.name}</td>
                    <td>${teacher.email || '-'}</td>
                    <td>${teacher.class || '-'}</td>
                    <td>${teacher.subject || '-'}</td>
                    <td>${teacher.username}</td>
                    <td>${teacher.password}</td>
                    <td><span class="status ${statusClass}">${teacher.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            ${teacher.status === 'active' ? 
                                `<button class="action-btn btn-warning" onclick="toggleTeacherStatus('${teacher.username}', 'inactive')">Deactivate</button>` : 
                                `<button class="action-btn btn-success" onclick="toggleTeacherStatus('${teacher.username}', 'active')">Activate</button>`
                            }
                            <button class="action-btn btn-danger" onclick="deleteTeacher('${teacher.username}')">Delete</button>
                        </div>
                    </td>
                `;
                teachersTable.appendChild(row);
            });
        }

        function updateTeacherDashboard() {
            const attendance = getData('attendance');
            const lessonNotes = getData('lessonNotes');
            const assignments = getData('assignments');

            const teacherAttendanceTable = document.getElementById('teacher-attendance-table');
            teacherAttendanceTable.innerHTML = '';
            const teacherAttendance = attendance.filter(record => record.teacher === currentUser.name)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            teacherAttendance.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.arrival || '-'}</td>
                    <td>${record.departure || '-'}</td>
                    <td>${record.hours > 0 ? record.hours + ' hours' : '-'}</td>
                    <td><span class="status status-${record.status === 'complete' ? 'approved' : 'pending'}">${record.status}</span></td>
                `;
                teacherAttendanceTable.appendChild(row);
            });

            const teacherLessonsTable = document.getElementById('teacher-lessons-table');
            teacherLessonsTable.innerHTML = '';
            const teacherNotes = lessonNotes.filter(note => note.teacher === currentUser.name);
            teacherNotes.forEach(note => {
                const statusClass = `status-${note.status}`;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${note.date}</td>
                    <td>${note.subject}</td>
                    <td>${note.note}</td>
                    <td><span class="status ${statusClass}">${note.status}</span></td>
                    <td>${note.feedback || '-'}</td>
                `;
                teacherLessonsTable.appendChild(row);
            });

            const teacherAssignmentsTable = document.getElementById('teacher-assignments-table');
            teacherAssignmentsTable.innerHTML = '';
            const teacherAssignments = assignments.filter(assignment => assignment.teacher === currentUser.name);
            teacherAssignments.forEach(assignment => {
                const statusClass = `status-${assignment.status}`;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${assignment.dueDate}</td>
                    <td>${assignment.class}</td>
                    <td>${assignment.subject}</td>
                    <td>${assignment.assignment}</td>
                    <td>${assignment.dueDate}</td>
                    <td><span class="status ${statusClass}">${assignment.status}</span></td>
                    <td>${assignment.feedback || '-'}</td>
                `;
                teacherAssignmentsTable.appendChild(row);
            });
        }

        function updateStudentDashboard() {
            const assignments = getData('assignments');
            const studentAssignmentsTable = document.getElementById('student-assignments-table');
            studentAssignmentsTable.innerHTML = '';
            const studentClass = currentUser.class;
            const studentAssignments = assignments.filter(assignment => 
                assignment.class === studentClass && assignment.status === 'approved'
            );
            if (studentAssignments.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="6" style="text-align: center;">No assignments available</td>`;
                studentAssignmentsTable.appendChild(row);
            } else {
                studentAssignments.forEach(assignment => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${assignment.teacher}</td>
                        <td>${assignment.subject}</td>
                        <td>${assignment.assignment}</td>
                        <td>${assignment.dueDate}</td>
                        <td><span class="status status-approved">Active</span></td>
                        <td>${assignment.feedback || '-'}</td>
                    `;
                    studentAssignmentsTable.appendChild(row);
                });
            }
        }

        function populateTeacherSelect() {
            const teacherSelect = document.getElementById('teacher-select');
            teacherSelect.innerHTML = '<option value="">Select Teacher</option>';
            const users = getData('users');
            const teachers = users.filter(user => user.role === 'teacher' && user.status === 'active');
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher.name;
                option.textContent = teacher.name;
                teacherSelect.appendChild(option);
            });
        }

        function recordAttendance() {
            const teacher = document.getElementById('teacher-select').value;
            const attendanceType = document.getElementById('attendance-type').value;
            if (!teacher) { alert('Please select a teacher'); return; }
            const now = new Date();
            const currentTime = now.toTimeString().split(' ')[0].substring(0, 5);
            const today = now.toISOString().split('T')[0];
            let attendance = getData('attendance');
            let attendanceRecord = attendance.find(record => record.teacher === teacher && record.date === today);
            if (attendanceRecord) {
                if (attendanceType === 'arrival') {
                    attendanceRecord.arrival = currentTime;
                    attendanceRecord.status = attendanceRecord.departure ? 'complete' : 'present';
                } else {
                    attendanceRecord.departure = currentTime;
                    if (attendanceRecord.arrival) {
                        const arrivalTime = new Date(`2000-01-01T${attendanceRecord.arrival}`);
                        const departureTime = new Date(`2000-01-01T${currentTime}`);
                        const hours = (departureTime - arrivalTime) / (1000 * 60 * 60);
                        attendanceRecord.hours = Math.round(hours * 10) / 10;
                    }
                    attendanceRecord.status = 'complete';
                }
            } else {
                attendanceRecord = {
                    date: today,
                    teacher: teacher,
                    arrival: attendanceType === 'arrival' ? currentTime : '',
                    departure: attendanceType === 'departure' ? currentTime : '',
                    hours: 0,
                    status: attendanceType === 'arrival' ? 'present' : 'incomplete'
                };
                attendance.push(attendanceRecord);
            }
            saveData('attendance', attendance);
            updateAdminDashboard();
            realTimeSync.addActivity(`Attendance recorded for ${teacher} at ${currentTime}`);
            alert(`Attendance recorded successfully for ${teacher} at ${currentTime}`);
        }

        function recordMyAttendance() {
            const attendanceType = document.getElementById('teacher-attendance-type').value;
            const teacher = currentUser.name;
            const now = new Date();
            const currentTime = now.toTimeString().split(' ')[0].substring(0, 5);
            const today = now.toISOString().split('T')[0];
            let attendance = getData('attendance');
            let attendanceRecord = attendance.find(record => record.teacher === teacher && record.date === today);
            if (attendanceRecord) {
                if (attendanceType === 'arrival') {
                    if (attendanceRecord.arrival) { alert('You have already recorded your arrival for today'); return; }
                    attendanceRecord.arrival = currentTime;
                    attendanceRecord.status = attendanceRecord.departure ? 'complete' : 'present';
                } else {
                    if (attendanceRecord.departure) { alert('You have already recorded your departure for today'); return; }
                    attendanceRecord.departure = currentTime;
                    if (attendanceRecord.arrival) {
                        const arrivalTime = new Date(`2000-01-01T${attendanceRecord.arrival}`);
                        const departureTime = new Date(`2000-01-01T${currentTime}`);
                        const hours = (departureTime - arrivalTime) / (1000 * 60 * 60);
                        attendanceRecord.hours = Math.round(hours * 10) / 10;
                    }
                    attendanceRecord.status = 'complete';
                }
            } else {
                attendanceRecord = {
                    date: today,
                    teacher: teacher,
                    arrival: attendanceType === 'arrival' ? currentTime : '',
                    departure: attendanceType === 'departure' ? currentTime : '',
                    hours: 0,
                    status: attendanceType === 'arrival' ? 'present' : 'incomplete'
                };
                attendance.push(attendanceRecord);
            }
            saveData('attendance', attendance);
            updateTeacherDashboard();
            realTimeSync.addActivity(`${teacher} recorded ${attendanceType} at ${currentTime}`);
            alert(`Your ${attendanceType} has been recorded at ${currentTime}`);
        }

        function approveLessonNote(id) {
            let lessonNotes = getData('lessonNotes');
            const note = lessonNotes.find(n => n.id === id);
            if (note) {
                note.status = 'approved';
                note.feedback = 'Approved by admin on ' + new Date().toLocaleDateString();
                saveData('lessonNotes', lessonNotes);
                updateAdminDashboard();
                realTimeSync.addActivity(`Lesson note approved for ${note.teacher}`);
            }
        }

        function rejectLessonNote(id) {
            let lessonNotes = getData('lessonNotes');
            const note = lessonNotes.find(n => n.id === id);
            if (note) {
                note.status = 'rejected';
                note.feedback = 'Please revise and resubmit. Feedback provided on ' + new Date().toLocaleDateString();
                saveData('lessonNotes', lessonNotes);
                updateAdminDashboard();
                realTimeSync.addActivity(`Lesson note rejected for ${note.teacher}`);
            }
        }

        function approveAssignment(id) {
            let assignments = getData('assignments');
            const assignment = assignments.find(a => a.id === id);
            if (assignment) {
                assignment.status = 'approved';
                assignment.feedback = 'Approved by admin on ' + new Date().toLocaleDateString();
                saveData('assignments', assignments);
                updateAdminDashboard();
                realTimeSync.addActivity(`Assignment approved for ${assignment.teacher}`);
            }
        }

        function rejectAssignment(id) {
            let assignments = getData('assignments');
            const assignment = assignments.find(a => a.id === id);
            if (assignment) {
                assignment.status = 'rejected';
                assignment.feedback = 'Please revise and resubmit. Feedback provided on ' + new Date().toLocaleDateString();
                saveData('assignments', assignments);
                updateAdminDashboard();
                realTimeSync.addActivity(`Assignment rejected for ${assignment.teacher}`);
            }
        }

        function addStudent() {
            const name = document.getElementById('student-name').value;
            const studentClass = document.getElementById('student-class').value;
            if (!name || !studentClass) { alert('Please enter student name and select a class'); return; }
            let students = getData('students');
            let users = getData('users');

            const newId = 'STU' + (students.length + 1).toString().padStart(3, '0');
            const username = name.toLowerCase().replace(/\s+/g, '') + (students.length + 1);
            const password = 'stud' + (students.length + 1);

            const newStudent = {
                id: newId, name: name, class: studentClass,
                username: username, password: password, addedBy: currentUser.name, status: 'active'
            };
            students.push(newStudent);
            saveData('students', students);

            users.push({ username: username, password: password, role: 'student', name: name, class: studentClass, status: 'active' });
            saveData('users', users);

            updateAdminDashboard();
            document.getElementById('student-name').value = '';
            document.getElementById('student-class').value = '';
            realTimeSync.addActivity(`New student added: ${name}`);
            alert(`Student added successfully!\nUsername: ${username}\nPassword: ${password}`);
        }

        function registerTeacher() {
            const name = document.getElementById('teacher-name').value;
            const email = document.getElementById('teacher-email').value;
            const teacherClass = document.getElementById('teacher-class').value;
            const subject = document.getElementById('teacher-subject').value;
            if (!name) { alert('Please enter teacher name'); return; }

            let users = getData('users');
            const username = name.toLowerCase().replace(/\s+/g, '') + (users.filter(u => u.role === 'teacher').length + 1);
            const password = 'pass' + (users.filter(u => u.role === 'teacher').length + 1);

            users.push({
                username: username, password: password, role: 'teacher',
                name: name, email: email, class: teacherClass, subject: subject, status: 'active'
            });
            saveData('users', users);

            updateAdminDashboard();
            document.getElementById('teacher-name').value = '';
            document.getElementById('teacher-email').value = '';
            document.getElementById('teacher-class').value = '';
            document.getElementById('teacher-subject').value = '';
            populateTeacherSelect();

            realTimeSync.addActivity(`New teacher registered: ${name}`);
            alert(`Teacher registered successfully!\nUsername: ${username}\nPassword: ${password}`);
        }

        function toggleTeacherStatus(username, status) {
            let users = getData('users');
            const teacher = users.find(u => u.username === username && u.role === 'teacher');
            if (teacher) {
                teacher.status = status;
                saveData('users', users);
                updateAdminDashboard();
                populateTeacherSelect();
                realTimeSync.addActivity(`Teacher ${teacher.name} status changed to ${status}`);
                alert(`Teacher status updated to ${status}`);
            }
        }

        function deleteTeacher(username) {
            if (confirm('Are you sure you want to delete this teacher? This action cannot be undone.')) {
                let users = getData('users');
                const teacherIndex = users.findIndex(u => u.username === username && u.role === 'teacher');
                if (teacherIndex !== -1) {
                    const teacherName = users[teacherIndex].name;
                    users.splice(teacherIndex, 1);
                    saveData('users', users);
                    updateAdminDashboard();
                    populateTeacherSelect();
                    realTimeSync.addActivity(`Teacher deleted: ${teacherName}`);
                    alert('Teacher deleted successfully');
                }
            }
        }

        function submitLessonNote() {
            const subject = document.getElementById('lesson-subject').value;
            const note = document.getElementById('lesson-note').value;
            if (!subject || !note) { alert('Please enter both subject and lesson note'); return; }
            let lessonNotes = getData('lessonNotes');
            lessonNotes.push({
                id: lessonNotes.length + 1,
                teacher: currentUser.name,
                date: new Date().toISOString().split('T')[0],
                subject: subject,
                note: note,
                status: 'pending',
                feedback: ''
            });
            saveData('lessonNotes', lessonNotes);
            updateTeacherDashboard();
            document.getElementById('lesson-subject').value = '';
            document.getElementById('lesson-note').value = '';
            realTimeSync.addActivity(`Lesson note submitted by ${currentUser.name}`);
            alert('Lesson note submitted successfully!');
        }

        function submitAssignment() {
            const assignmentClass = document.getElementById('assignment-class').value;
            const subject = document.getElementById('assignment-subject').value;
            const details = document.getElementById('assignment-details').value;
            const dueDate = document.getElementById('due-date').value;
            if (!assignmentClass || !subject || !details || !dueDate) { alert('Please fill in all fields'); return; }

            let assignments = getData('assignments');
            assignments.push({
                id: assignments.length + 1,
                teacher: currentUser.name,
                class: assignmentClass,
                subject: subject,
                assignment: details,
                dueDate: dueDate,
                status: 'pending',
                feedback: ''
            });
            saveData('assignments', assignments);
            updateTeacherDashboard();
            document.getElementById('assignment-class').value = '';
            document.getElementById('assignment-subject').value = '';
            document.getElementById('assignment-details').value = '';
            document.getElementById('due-date').value = '';
            realTimeSync.addActivity(`Assignment submitted by ${currentUser.name}`);
            alert('Assignment submitted successfully!');
        }

        function showMessage(element, text, type) {
            element.textContent = text;
            element.className = `message ${type}`;
            element.style.display = 'block';
            setTimeout(() => { element.style.display = 'none'; }, 3000);
        }
    </script>
</body>
</html>
